<html>
  <head>
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore.js" type="text/javascript"></script>
  </head>
  <body>
    <div id='main'>
      <div id='header'></div>
      <div id='invitation'></div>
      <div id='notes'></div>
    </div>
    <script type="text/javascript">
    $(function() {

      $attach('#header', 'mkHostHeader', [
        "ICLR 2016 - Workshop Track",
        "International Conference on Learning Representations",
        "May 2 - 4, 2016, Caribe Hilton, San Juan, Puerto Rico",
        "http://www.iclr.cc/doku.php?id=iclr2016:main",
        "18 Feb 2016"
      ], true);

      var sm = mkStateManager();

      var httpGetP = function(url, queryOrBody) {
        var df = $.Deferred();
        httpGet(url, queryOrBody, function(result) {
          df.resolve(result);
        }, function(err) {
          df.reject(result);
        });
        return df.promise();
      };

      var invitationP = httpGetP('invitations', {id: 'iclr.cc/2016/workshop/-/submission'}).then(function(result) {
        return result.invitations[0];
      });

      var readersP = invitationP.then(function(invitation) {
        return httpGetP('groups', {listRegex: invitation.reply.readers}).then(function(result) {
          return _.map(result.groups, function(g) {
            return g.id;
          });
        });
      });

      var signaturesP = invitationP.then(function(invitation) {
        if (user) {
          return httpGetP('groups', {listRegex: invitation.reply.signatures, signatory: user.id}).then(function(result) {
            return _.map(result.groups, function(g) {
              return g.id;
            });
          });
        } else {
          return [];
        }
      });

      var notesP = httpGetP('notes', {invitation: 'iclr.cc/2016/workshop/-/submission', maxtcdate: Date.now()}).then(function(result) {
        return result.notes;
      });


      $.when(invitationP, readersP, signaturesP, notesP).done(function(invitation, readers, signatures, notes) {
        sm.update('invitationTrip', {
          invitation: invitation,
          readers: readers,
          signatures: signatures
        });
        sm.update('notes', notes);
      });

      sm.addHandler('workshop', {

        invitationTrip: function(invitationTrip) { if (invitationTrip) {
          var invitation = invitationTrip.invitation;
          var readers = invitationTrip.readers;
          var signatures = invitationTrip.signatures;
          $attach('#invitation', 'mkInvitationButton', [invitation, function() {
            if (signatures.length > 0) {
              $attach('#notes', 'mkSlimNewNoteEditor', [invitation, null, user, readers, signatures, {
                onNoteCreated: function(idRecord) {
                  httpGetP('notes', {
                    invitation: 'iclr.cc/2016/workshop/-/submission', 
                    maxtcdate: Date.now()
                  }).then(function(result) {
                    console.log("time to update notes: " + result.notes.length);
                    sm.update('notes', result.notes);
                  });
                }
              }], false);
            } else {
             promptLogin(user);
            }
          }], true);
        }},

        notes: function(notes) {
          if (notes) {
            $('#notes').empty();
            _.forEach(notes, function(note) {
              $attach('#notes', 'mkNotePanel', [note, {
                titleLink: 'HREF',
                withReplyCount: true
              }], true);
            });
          }
        }
      });
      



    });
    </script>
 </body>
</html>
