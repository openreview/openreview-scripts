<!-- UI for Area Chair Console -->
<script type="text/javascript">
$(function() {
  var CONFERENCE = 'auai.org/UAI/2017';
  var allNotes = null;
  var userProfiles = null;

  // Ajax functions
  var getPaperNumbersfromGroups = function(groups) {
    var re = /^auai\.org\/UAI\/2017\/Paper(\d+)\/Area_Chair/;
    return _.map(
      _.filter(groups, function(g) { return re.test(g.id); }),
      function(fg) { return parseInt(fg.id.match(re)[1], 10); }
    );
  };

  var getBlindedNotes = function(noteNumbers) {
    var noteNumbersStr = noteNumbers.join(',');

    return $.getJSON('notes', { invitation: CONFERENCE + '/-/blind-submission', number: noteNumbersStr })
      .then(function(result) {
        return result.notes;
      });
  };

  var getTagInvitations = function() {
    return $.getJSON('invitations', { replyInvitation: CONFERENCE + '/-/blind-submission', tags: true })
      .then(function(result) {
        return _.filter(result.invitations, function(invitation) {
          return _.endsWith(invitation.id, 'Recommend/Reviewer');  //TODO
        });
      })
      .fail(function(error) {
        return null;
      });
  };


  // Render functions
  var displayHeader = function(headerP) {
    var $panel = $('#group-container');
    $panel.hide('fast', function() {
      $panel.empty().append(
        '<div id="header" class="panel">' +
          '<h1>UAI Area Chair Console</h1><br>' +
        '</div>' +
        '<div id="notes"><div class="tabs-container"></div></div>'
      );

      var loadingMessage = '<p class="empty-message">Loading...</p>';
      var tabsData = {
        sections: [
          {
            heading: 'Reviewer Status',
            id: 'reviewer-status',
            content: loadingMessage,
            active: true
          },
          {
            heading: 'My Assigned Papers',
            id: 'assigned-papers',
            content: loadingMessage,
          }
        ]
      };
      $panel.find('.tabs-container').append(Handlebars.templates['components/tabs'](tabsData));

      $panel.show('fast', function() {
        headerP.resolve(true);
      });
    });
  };

  var displayStatusTable = function(notes, container, options) {
    var tableData = {
      headings: ['#', 'Paper Summary', 'Review Progress', 'Status'],
      rows: _.map(notes, buildTableRow),
      extraClasses: 'table-hover'
    };

    $(container).empty().append(Handlebars.templates['components/table'](tableData));
  };

  var displayNotes = function(notes, tagInvitations) {
    var container = '#assigned-papers';
    var displayOptions = {
      titleLink: 'HREF',
      withReplyCount: true,
      withContent: true,
      collapseContent: true,
      user: user,
      tagInvitations: tagInvitations
    };

    $('.note.panel, .empty-message', container).remove();
    _.forEach(notes, function(note) {
      $attach(container, 'mkNotePanel', [note, displayOptions], true);
    });

    if (!notes.length) {
      $(container).append('<p class="empty-message">You don\'t have assigned papers</p>');
    }
  };

  var displayError = function(message) {
    message = message || 'The group data could not be loaded.';
    $('#notes').empty().append('<div class="alert alert-danger"><strong>Error:</strong> ' + message + '</div>');
  };


  // Helper functions
  var buildTableRow = function(note) {
    var number = '<strong>' + note.number + '</strong>';
    var paperSummary = Handlebars.templates.noteSummary(note);
    var reviewProgress = '<p>TODO</p>';
    var status = '<p>TODO</p>';

    return [number, paperSummary, reviewProgress, status];
  };


  // Kick the whole thing off
  var headerLoaded = $.Deferred();
  displayHeader(headerLoaded);

  controller.addHandler('areachairs', {
    token: function(token) {
      var pl = model.tokenPayload(token);
      var user = pl.user;

      var userAreachairGroupsP = $.getJSON('groups', { member: user.id, regex: CONFERENCE + '/Paper.*/Area_Chair' })
        .then(function(result) {
          var noteNumbers = getPaperNumbersfromGroups(result.groups);
          return $.when(getBlindedNotes(noteNumbers), getTagInvitations(), headerLoaded);
        })
        .then(function(blindedNotes, tagInvitations, loaded) {
          displayNotes(blindedNotes, tagInvitations);
          displayStatusTable(blindedNotes, '#reviewer-status');
        })
        .fail(function(error) {
          displayError();
        });
    }
  });

  OpenBanner.breadcrumbs([
    { link: '/', text: 'Venues' },
    { link: '/group?id=' + CONFERENCE, text: view.prettyId(CONFERENCE) }
  ]);
});
</script>
