<!-- UI for Reviewer Status page -->
<script type="text/javascript">
$(function() {

  var httpGetP = function(url, queryOrBody) {
    var df = $.Deferred();
    httpGet(url, queryOrBody, function(result) {
      df.resolve(result);
    }, function(result) {
      df.reject(result);
    });
    return df.promise();
  };

  var notesP = httpGetP('notes', {invitation: 'auai.org/UAI/2017/-/blind-submission'}).then(function(result) {
    return result.notes;
  }, function(error) {
    return error
  });

  var tagInvitationsP = httpGetP('invitations', {id: 'auai.org/UAI/2017/-/Add/Bid'}).then(function(result) {
    return result.invitations;
  }, function(error) {
    return error
  });

  var displayError = function() {
    $('#invitation-container').empty().append('<div class="alert alert-warning"><strong>Error:</strong> The invitation content could not be displayed.</div>');
  }

  if (!_.has(Handlebars, 'templates.components/tabs')) {
    displayError();
    return false;
  }

  $.when(notesP, tagInvitationsP).done(function(notes, tagInvitations) {
    var sm = mkStateManager();
    var allNotes = [];
    var activeTab = 0;

    sm.update('notes', {
      notes: notes
    });

    sm.addHandler('conference', {
      notes: function(data) {
        allNotes = data.notes;

        if (allNotes) {
          updateNotes(allNotes);
        }
      }
    });

    function displayNotes(notes, container) {
      _.forEach(notes, function(note) {
        var onTagChanged = function(tag) {
          allNotes = _.map(allNotes, function(n) {
            if (n.id == note.id) {
              n.tags = [tag];
            }
            return n;
          });
          updateNotes(allNotes);
        }

        $attach(container, 'mkNotePanel', [note, {
          titleLink: 'HREF',
          withReplyCount: true,
          withContent: true,
          collapseContent: true,
          onTagChanged: onTagChanged,
          user: user,
          tagInvitations: tagInvitations
        }], true);
      });

      if (!notes.length) {
        $(container).append('<p class="empty-message">No papers to display</p>');
      }
    }

    function updateNotes(notes) {
      // Sort notes by bid
      var wantToReview = [];
      var canReview = [];
      var probablyReview = [];
      var canNotReview = [];
      var noBid = [];
      for (var n of notes) {
        if (n.tags.length) {
          if (n.tags[0].tag === 'I want to review') {
            wantToReview.push(n);
          } else if (n.tags[0].tag === 'I can review') {
            canReview.push(n);
          } else if (n.tags[0].tag === 'I can probably review but am not an expert') {
            probablyReview.push(n);
          } else if (n.tags[0].tag === 'I cannot review') {
            canNotReview.push(n);
          } else {
            noBid.push(n);
          }
        } else {
          noBid.push(n);
        }
      }

      var bidCount = wantToReview.length + canReview.length + probablyReview.length + canNotReview.length;

      var $panel = $('#invitation-container');
      $panel.empty().append(
        '<div id="header" class="panel">' +
          '<h1>UAI Paper Bidding</h1>' +
          '<h3>You have completed ' + bidCount + '/50 bids</h3>' +
        '</div>' +
        '<div class="tabs-container"></div>'
      );

      var searchBarHTML = '<form class="form-inline search-form" role="search">' +
        '<div class="form-group has-feedback">' +
          '<input id="paper-search-input" type="text" class="form-control" placeholder="Search papers by title" autocomplete="off">' +
          '<span class="glyphicon glyphicon-search form-control-feedback" aria-hidden="true"></span>' +
        '</div></form>';

      var templateData = {
        sections: [
          {
            heading: 'No bid',
            headingCount: noBid.length,
            id: 'noBid',
            content: null
          },
          {
            heading: 'I want to review',
            headingCount: wantToReview.length,
            id: 'wantToReview',
            content: null
          },
          {
            heading: 'I can review',
            headingCount: canReview.length,
            id: 'canReview',
            content: null
          },
          {
            heading: 'I can probably review but am not an expert',
            headingCount: probablyReview.length,
            id: 'probablyReview',
            content: null
          },
          {
            heading: 'I cannot review',
            headingCount: canNotReview.length,
            id: 'canNotReview',
            content: null
          },
          {
            heading: 'Search &nbsp;<span class="glyphicon glyphicon-search"></span>',
            id: 'allPapers',
            content: searchBarHTML
          }
        ]
      };
      templateData.sections[activeTab].active = true;
      $panel.find('.tabs-container').append(Handlebars.templates['components/tabs'](templateData));

      $('ul.nav-tabs a', $panel).click(function(e) {
        $(this).tab('show');
        return false;
      });

      displayNotes(wantToReview, '#wantToReview');
      displayNotes(canReview, '#canReview');
      displayNotes(probablyReview, '#probablyReview');
      displayNotes(canNotReview, '#canNotReview');
      displayNotes(noBid, '#noBid');
      displayNotes(notes, '#allPapers');
    }

    function filterPapers() {
      var $inputElem = $(this).is('input') ? $(this) : $(this).find('input');
      var term = $inputElem.val().trim().toLowerCase();
      var filteredNotes;

      if (!term) {
        filteredNotes = allNotes;
      } else if (term.length < 3) {
        return false;
      } else {
        filteredNotes = _.filter(allNotes, function(n) {
          return n.content.title.toLowerCase().indexOf(term) !== -1;
        });
      }

      $('#allPapers .note.panel').remove();
      displayNotes(filteredNotes, '#allPapers');
      return false;
    }

    $('#invitation-container').on('shown.bs.tab', 'ul.nav-tabs li a', function (e) {
      activeTab = $(e.target).data('tabIndex');
      console.log(activeTab);
    });

    $('#invitation-container').on('submit', 'form.search-form', filterPapers);
    $('#invitation-container').on('keyup', 'form.search-form input', _.debounce(filterPapers, 300));

  }).fail(function(){
    displayError();
  });

});
</script>
