<html>
  <head>
  </head>
  <body>
    <div id='main'>
      <div id='header'></div>
      <div id='invitation'></div>
      <div id='notes'></div>
    </div>
    <script type="text/javascript">
    $(function() {

      $attach('#header', 'mkHostHeader', [
        "UAI 2017 Conference",
        "International Conference on Learning Representations",
        "Sydney, Australia, August 11 - 15, 2017",
        "http://auai.org/uai2017/"
      ], true);

      var sm = mkStateManager();

      var httpGetP = function(url, queryOrBody) {
        var df = $.Deferred();
        httpGet(url, queryOrBody,
        function(result) {
          df.resolve(result);
        },
        function(result) {
          df.reject(result);
        });
        return df.promise();
      };

      var invitationP = httpGetP('invitations', {id: 'auai.org/UAI/2017/-/submission'}).then(function(result) {
        console.log('result',result);
        var valid_invitations = _.filter(result.invitations, function(inv){
          return inv.duedate > Date.now();
        })
        return valid_invitations[0];
      },
      function(error){
        return error;
      });

      var getNotes = function() {
        return httpGetP('notes', {invitation: 'auai.org/UAI/2017/-/blind-submission'}).then(function(result) {
          return result.notes;
        },
        function(error){
          return error;
        });
      }

      var getTagInvitations = function() {
        return httpGetP('invitations', {replyInvitation: 'auai.org/UAI/2017/-/blind-submission', tags: true}).then(function(result) {
          return result.invitations;
        },
        function(error){
          return error;
        });
      }

      $.when(invitationP, getNotes(), getTagInvitations()).done(function(invitation, notes, tagInvitations) {

        if(invitation){
          sm.update('invitationTrip', {
            invitation: invitation
          });
        }
        sm.update('notes', {
          notes: notes,
          tagInvitations: tagInvitations
        });

        sm.addHandler('conference', {
          invitationTrip: function(invitationTrip) { if (invitationTrip) {
            var invitation = invitationTrip.invitation;
            $attach('#invitation', 'mkInvitationButton', [invitation, function() {
              if (user && invitation) {
                view.mkNewNoteEditor(invitation, null, null, user, {
                  onNoteCreated: function(idRecord) {
                    $.when(getNotes(), getTagInvitations()).done(function(notes, tagInvitations) {
                      sm.update('notes', {
                        notes: notes,
                        tagInvitations: tagInvitations
                      });
                    });
                  },
                  onCompleted: function(editor) {
                    $('#notes').prepend(editor);
                  }
                });
              } else {
               promptLogin(user);
              }
            }], true);
          }},

          notes: function(data) {

            var notes = data.notes;
            var tagInvitations = data.tagInvitations;

            if (notes.length > 0) {
              $('#notes').empty().append('<h3>Submitted Papers</h3><hr>');
              _.forEach(notes, function(note) {
                $attach('#notes', 'mkNotePanel', [note, {
                  titleLink: 'HREF',
                  withReplyCount: true,
                  user: user,
                  tagInvitations: tagInvitations
                }], true);
              });
            }
          }
        });

      })
      .fail(function(){
        console.log("Invitation and/or notes not found")
      });





    });
    </script>
 </body>
</html>
