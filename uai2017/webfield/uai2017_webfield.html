<!-- UAI Homepage -->
<script type="text/javascript">
$(function() {

  var httpGetP = function(url, queryOrBody) {
    var df = $.Deferred();
    httpGet(url, queryOrBody, function(result) {
      df.resolve(result);
    }, function(result) {
      df.reject(result);
    });
    return df.promise();
  };

  var getInvitation = function() {
    return httpGetP('invitations', {id: 'auai.org/UAI/2017/-/submission'}).then(function(result) {
      var valid_invitations = _.filter(result.invitations, function(inv) {
        return inv.duedate > Date.now();
      });
      return valid_invitations[0];
    }, function(error) {
      return error;
    });
  };

  var getNotes = function() {
    return httpGetP('notes', {invitation: 'auai.org/UAI/2017/-/blind-submission'}).then(function(result) {
      return result.notes;
    }, function(error) {
      return error;
    });
  };

  var getAssignedNotes = function() {
    return httpGetP('notes', {invitee: true, duedate: true}).then(function(result) {
      return _.map(
        _.filter(
          result.notes,
          function(n) { return n.replytoNote.invitation === 'auai.org/UAI/2017/-/blind-submission'; }
        ),
        function(n) { return n.replytoNote; }
      );
    }, function(error) {
      return error;
    });
  };

  var getTagInvitations = function() {
    return httpGetP('invitations', {replyInvitation: 'auai.org/UAI/2017/-/blind-submission', tags: true}).then(function(result) {
      return result.invitations;
    }, function(error) {
      return error;
    });
  };

  var getUserGroups = function() {
    if (!user || user.id.startsWith('_guest')) {
      return [];
    }

    return httpGetP('groups', {member: user.id}).then(function(result) {
      return _.filter(
        _.map(result.groups, function(g) { return g.id; }),
        function(id) { return _.startsWith(id, 'auai.org/UAI/2017') || id === '~Super_User1'; }
      );
    }, function(error) {
      return error;
    });
  };

  var getPaperNumbersfromGroups = function(groups) {
    var re = /auai.org\/UAI\/2017\/Paper(\d+)\/Authors/;
    return _.map(
      _.filter(groups, function(gid) { return re.test(gid); }),
      function(fgid) { return parseInt(fgid.match(re)[1], 10); }
    );
  };

  var renderConferenceHeader = function() {
    $('#group-container').append(
      '<div id="header"></div>',
      '<div id="invitation"></div>',
      '<div id="notes"><div class="tabs-container" style="display: none;"></div></div>'
    );
    $attach('#header', 'mkHostHeader', [
      "UAI 2017 Conference",
      "International Conference on Learning Representations",
      "Sydney, Australia, August 11 - 15, 2017",
      "http://auai.org/uai2017/"
    ], true);
  };

  var renderConferenceInvitations = function(invitationTrip) {
    if (invitationTrip) {
      var invitation = invitationTrip.invitation;

      var onInvitationButtonClicked = function() {
        if (user && !user.id.startsWith('guest_')) {
          view.mkNewNoteEditor(invitation, null, null, user, {
            onNoteCreated: function(idRecord) {
              $.when(getNotes(), getTagInvitations()).done(function(notes, tagInvitations) {
                sm.update('notes', {
                  notes: notes,
                  tagInvitations: tagInvitations
                });
              });
            },

            onCompleted: function(editor) {
              $('#notes').prepend(editor);
            }
          });

        } else {
          promptLogin(user);
        }
      };

      $attach('#invitation', 'mkInvitationButton', [invitation, onInvitationButtonClicked], true);
    }
  };

  var renderConferenceTabs = function() {
    $('#notes .tabs-container').empty();

    var templateData = {
      sections: [
        {
          heading: 'All Papers',
          headingCount: null,
          id: 'all-papers',
          content: null,
          active: true
        },
        {
          heading: 'My Submitted Papers',
          headingCount: null,
          id: 'my-submitted-papers',
          content: null,
        },
        {
          heading: 'My Tasks',
          headingCount: null,
          id: 'my-tasks',
          content: null
        }
      ]
    };

    $('#notes .tabs-container').append(Handlebars.templates['components/tabs'](templateData));
  };

  var renderConferenceNotes = function(data) {
    var notes = data.notes;
    var assignedNotes = data.assignedNotes;
    var tagInvitations = data.tagInvitations;

    var acGroups = ['auai.org/UAI/2017/Program_Committee', 'auai.org/UAI/2017/Senior_Program_Committee', 'auai.org/UAI/2017/Program_Co-Chairs'];
    if (_.intersection(userGroups, acGroups).length) {
      displayNotes(notes, tagInvitations, '#all-papers');

      var submittedPapers = getPaperNumbersfromGroups(userGroups);
      var filteredNotes = _.filter(notes, function(n) { return _.includes(submittedPapers, n.number); });
      if (filteredNotes.length) {
        displayNotes(filteredNotes, tagInvitations, '#my-submitted-papers');
      } else {
        $('.tabs-container a[href="#my-submitted-papers"]').parent().hide();
      }
    } else {
      $('.tabs-container a[href="#all-papers"]').parent().hide();

      displayNotes(notes, tagInvitations, '#my-submitted-papers');
    }

    if (assignedNotes.length) {
      displayNotes(assignedNotes, tagInvitations, '#my-tasks');
    } else {
      $('.tabs-container a[href="#my-tasks"]').parent().hide();
    }

    $('#notes .tabs-container').fadeIn('fast', function() {
      $('.tabs-container li:visible a').eq(0).click();
    });
  };

  var displayNotes = function(notes, tagInvitations, container) {
    _.forEach(notes, function(note) {
      $attach(container, 'mkNotePanel', [note, {
        titleLink: 'HREF',
        withReplyCount: true,
        user: user,
        tagInvitations: tagInvitations
      }], true);
    });

    if (!notes.length) {
      $(container).append('<p class="empty-message">No papers to display</p>');
    }
  };

  var displayError = function(message) {
    message = message || 'The venue invitation and/or papers could not be loaded.';
    $('#notes').empty().append('<div class="alert alert-danger"><strong>Error:</strong> ' + message + '</div>');
  };
    var displayWarning = function(message) {
    message = message || 'Please login to submit or review papers for this venue.';
    $('#notes').empty().append('<div class="alert alert-warning">' + message + '</div>');
  };


  // Render page
  var userGroups = [];

  renderConferenceHeader();

  $.when(getUserGroups()).then(function(groups) {
    userGroups = groups;
    if (_.isEmpty(userGroups)) {
      displayWarning();
      return false;
    }

    renderConferenceTabs();

    $.when(getInvitation(), getNotes(), getAssignedNotes(), getTagInvitations()).done(function(invitation, notes, assignedNotes, tagInvitations) {
      var sm = mkStateManager();

      if (invitation) {
        sm.update('invitationTrip', {
          invitation: invitation
        });
      }

      sm.update('notes', {
        notes: notes,
        assignedNotes: assignedNotes,
        tagInvitations: tagInvitations
      });

      sm.addHandler('conference', {
        invitationTrip: renderConferenceInvitations,
        notes: renderConferenceNotes
      });

    }).fail(function() {
      displayError();
    });
  }).fail(function() {
    displayWarning();
  });

});
</script>

