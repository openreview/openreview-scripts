<!-- UI for Reviewer Recommendation page -->
<script type="text/javascript">
$(function() {

  var httpGetP = function(url, queryOrBody) {
    var df = $.Deferred();
    httpGet(url, queryOrBody, function(result) {
      df.resolve(result);
    }, function(result) {
      df.reject(result);
    });
    return df.promise();
  };

  var onTokenChange = function(token) {

    var pl = model.tokenPayload(token);
    var user = pl.user;

    var userAreachairGroupsP = httpGetP('groups', {member: user.id, regex:'auai.org/UAI/2017/Paper.*/Area_Chair'}).then(
      function(result){
        return result.groups;
      },
      function(error){
        console.log('error');
        return error;
      }
    );

    userAreachairGroupsP.then(function(userAreachairGroups){
      var regex = /auai\.org\/UAI\/2017\/Paper(.*)\/Area_Chair/;
      return _.map(userAreachairGroups, function(group){
        var result = group.id.match(regex);
        return result.length > 1 && result[1];
      });
    })
    .then(function(noteNumbers) {
      var notesP = httpGetP('notes', { invitation: 'auai.org/UAI/2017/-/blind-submission', number: noteNumbers.join()})
      .then(function(result) {
        return result.notes;
      });
      var tagInvitationsP = httpGetP('invitations', {replyInvitation: 'auai.org/UAI/2017/-/blind-submission', tags: true}).then(function(result) {
        return _.filter(result.invitations, function(invitation) {
          return invitation.id.endsWith('Recommend/Reviewer');
        });
      }, function(error){
        return error
      });
      return $.when(notesP, tagInvitationsP);
    })
    .then(function(notes, tagInvitations) {
      displayNotes(notes, tagInvitations);
    });

  };

  var displayNotes = function(notes, tagInvitations) {
    var $panel = $('#group-container');
    $panel.empty().append(
      '<div id="header" class="panel">' +
        '<h1>UAI Area Chair Assigned Papers</h1>' +
        '<hr>' +
        '<h3>Please recommend reviewers for your assigned papers</h3>' +
      '</div>' +
      '<div class="notes-container"></div>'
    );

    var $notesContainer = $panel.find('.notes-container');
    _.forEach(notes, function(note) {
      $attach($notesContainer, 'mkNotePanel', [note, {
        titleLink: 'HREF',
        withReplyCount: true,
        withContent: true,
        collapseContent: true,
        user: user,
        tagInvitations: tagInvitations
      }], true);
    });
  }

  controller.addHandler('areachairs', {
    token: onTokenChange,
  });

});
</script>
