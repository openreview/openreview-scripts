<!-- UI for Reviewer Recommendation page -->
<script type="text/javascript">
$(function() {

  var httpGetP = function(url, queryOrBody) {
    var df = $.Deferred();
    httpGet(url, queryOrBody, function(result) {
      df.resolve(result);
    }, function(result) {
      df.reject(result);
    });
    return df.promise();
  };

  var notesP = httpGetP('notes', {invitation: 'auai.org/UAI/2017/-/blind-submission'}).then(function(result) {
    return result.notes;
  }, function(error){
    return error
  });

  var tagInvitationsP = httpGetP('invitations', {id: 'auai.org/UAI/2017/-/Recommend/Reviewer'}).then(function(result) {
    return result.invitations;
  }, function(error){
    return error
  });

  var displayError = function() {
    $('#invitation-container').empty().append('<div class="alert alert-warning"><strong>Error:</strong> The invitation content could not be displayed.</div>');
  }

  if (!_.has(Handlebars, 'templates.components/tabs')) {
    displayError();
    return false;
  }

  $.when(notesP, tagInvitationsP).done(function(notes, tagInvitations) {
    var sm = mkStateManager();
    var allNotes = [];

    sm.update('notes', {
      notes: notes
    });

    sm.addHandler('conference', {
      notes: function(data) {
        allNotes = data.notes;

        if (allNotes) {
          updateNotes(allNotes);
        }
      }
    });

    function displayNotes(notes, $panel) {
      _.forEach(notes, function(note) {
        $attach($panel, 'mkNotePanel', [note, {
          titleLink: 'HREF',
          withReplyCount: true,
          user: user,
          tagInvitations: tagInvitations
        }], true);
      });
    }

    function updateNotes(notes) {
      var $panel = $('#invitation-container');
      $panel.empty().append(
        '<div id="header" class="panel">' +
          '<h1>UAI Area Chair Status</h1>' +
          '<hr>' +
        '</div>' +
        '<div class="notes-container"></div>'
      );

      $notesContainer = $panel.find('.notes-container');
      displayNotes(_.sortBy(notes, function(n) {
        if (n.tags && _.find(n.tags, { invitation: 'auai.org/UAI/2017/-/Recommend/Reviewer' })) {
          return 0;
        }

        return 1;
      }), $notesContainer);
    }

  }).fail(function() {
    displayError();
  });

});
</script>
