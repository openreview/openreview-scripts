<!-- UI for Area Chair Console -->
<script type="text/javascript">
$(function() {
  var CONFERENCE = 'auai.org/UAI/2017';

  // Ajax functions
  var getPaperNumbersfromGroups = function(groups) {
    var re = /^auai\.org\/UAI\/2017\/Paper(\d+)\/Area_Chair/;
    return _.map(
      _.filter(groups, function(g) { return re.test(g.id); }),
      function(fg) { return parseInt(fg.id.match(re)[1], 10); }
    );
  };

  var getBlindedNotes = function() {
    return $.getJSON('notes', { invitation: CONFERENCE + '/-/blind-submission' })
      .then(function(result) {
        return result.notes;
      });
  };

  var getOfficialReviews = function(noteNumbers) {
    var noteMap = buildNoteMap(noteNumbers);

    return $.getJSON('notes', { invitation: CONFERENCE + '/-/Paper.*/Submit/Review' })
      .then(function(result) {
        var re = /^auai\.org\/UAI\/2017\/Paper(\d+)\/AnonReviewer(\d+)/;
        var ratingExp = /^(\d+): .*/;

        result.notes.forEach(function(n) {
          var matches = n.signatures[0].match(re);
          var num, index, ratingMatch;
          if (matches) {
            num = parseInt(matches[1], 10);
            index = parseInt(matches[2], 10);

            if (num in noteMap) {
              // Need to parse rating and confidence strings into ints
              ratingMatch = n.content.rating.match(ratingExp);
              n.rating = ratingMatch ? parseInt(ratingMatch[1], 10) : null;
              confidenceMatch = n.content.confidence.match(ratingExp);
              n.confidence = confidenceMatch ? parseInt(confidenceMatch[1], 10) : null;

              noteMap[num][index] = n;
            }
          }
        });
        return noteMap;
      })
      .fail(function(error) {
        displayError();
        return null;
      });
  };

  var getReviewerGroups = function(noteNumbers) {
    var noteMap = buildNoteMap(noteNumbers);
    var reviewerMap = {};

    return $.getJSON('groups', { regex: 'auai.org/UAI/2017/Paper.*/AnonReviewer.*' })
      .then(function(result) {
        var re = /^auai\.org\/UAI\/2017\/Paper(\d+)\/AnonReviewer(\d+)/;

        result.groups.forEach(function(g) {
          var matches = g.id.match(re);
          var num, index;
          if (matches) {
            num = parseInt(matches[1], 10);
            index = parseInt(matches[2], 10);

            if (g.members.length) {
              var reviewer = g.members[0];
              if ((num in noteMap)) {
                noteMap[num][index] = reviewer;
              }

              if (!(reviewer in reviewerMap)) {
                reviewerMap[reviewer] = [];
              }

              reviewerMap[reviewer].push(num);
            }

          }
        });
        return {
          byNotes: noteMap,
          byReviewers: reviewerMap
        };
      })
      .fail(function(error) {
        displayError();
        return null;
      });
  };

  var getAreaChairGroups = function(noteNumbers) {
    var noteMap = buildNoteMap(noteNumbers);
    var areaChairMap = {};

    return $.getJSON('groups', { regex: 'auai.org/UAI/2017/Paper.*/Area_Chair' })
      .then(function(result) {
        var re = /^auai\.org\/UAI\/2017\/Paper(\d+)\/Area_Chair/;

        result.groups.forEach(function(g) {
          var matches = g.id.match(re);
          var num;
          if (matches) {
            num = parseInt(matches[1], 10);

            if (g.members.length) {
              var areaChair = g.members[0];
              if (num in noteMap) {
                noteMap[num][0] = areaChair;
              }

              if (!(areaChair in areaChairMap)) {
                areaChairMap[areaChair] = [];
              }
              areaChairMap[areaChair].push(num);
            }
          }
        });
        return {
          byNotes: noteMap,
          byAreaChairs: areaChairMap
        };
      })
      .fail(function(error) {
        displayError();
        return null;
      });
  };

  var getUserProfiles = function(userIds) {
    return $.post('/user/profiles', JSON.stringify({ids: userIds}))
    .then(function(result) {

      var profileMap = {};

      _.forEach(result.profiles, function(profile) {

        var name = _.find(profile.content.names, ['preferred', true]) || _.first(profile.content.names);
        profile.name = _.isEmpty(name) ? view.prettyId(profile.id) : name.first + ' ' + name.last;
        profile.email = profile.content.preferred_email;
        profileMap[profile.id] = profile;
      })

      console.log('profileMap', profileMap);
      return profileMap;
    })
    .fail(function(error) {
      displayError();
      return null;
    });
  };

  var getMetaReviews = function() {
    return $.getJSON('notes', { invitation: CONFERENCE + '/-/Paper.*/Meta/Review' })
      .then(function(result) {
        return result.notes;
      }).fail(function(error) {
        displayError();
        return null;
      });
  };


  // Render functions
  var displayHeader = function(headerP) {
    var $panel = $('#group-container');
    $panel.hide('fast', function() {
      $panel.empty().append(
        '<div id="header" class="panel">' +
          '<h1>UAI Program Co-Chairs Console</h1><br>' +
        '</div>' +
        '<div id="notes"><div class="tabs-container"></div></div>'
      );

      var loadingMessage = '<p class="empty-message">Loading...</p>';
      var tabsData = {
        sections: [
          {
            heading: 'Paper Status',
            id: 'paper-status',
            content: loadingMessage,
            active: true
          },
          {
            heading: 'Area Chair Status',
            id: 'areachair-status',
            content: loadingMessage,
          },
          {
            heading: 'Reviewer Status',
            id: 'reviewer-status',
            content: loadingMessage,
          }
        ]
      };
      $panel.find('.tabs-container').append(Handlebars.templates['components/tabs'](tabsData));

      $panel.show('fast', function() {
        headerP.resolve(true);
      });
    });
  };

  var displayPaperStatusTable = function(profiles, notes, completedReviews, metaReviews, reviewerIds, areachairIds, container, options) {

    var rowData = _.map(notes, function(note) {
      var revIds = reviewerIds[note.number];
      for (var revNumber in revIds) {
        var profile = profiles[revIds[revNumber]];
        revIds[revNumber] = profile;
      }

      var areachairId = areachairIds[note.number][0];
      var areachairProfile = {}

      if (areachairId) {
        areachairProfile = profiles[areachairId];
      } else {
        areachairProfile.name = view.prettyId('auai.org/UAI/2017/-/Paper' + note.number + '/Area_Chair');
        areachairProfile.email = '-';
      }
      var metaReview = _.find(metaReviews, ['invitation', 'auai.org/UAI/2017/-/Paper' + note.number + '/Meta/Review']);
      return buildPaperTableRow(note, revIds, completedReviews[note.number], metaReview, areachairProfile);
    });

    var tableHTML = Handlebars.templates['components/table']({
      headings: ['#', 'Paper Summary', 'Review Progress', 'Status'],
      rows: rowData,
      extraClasses: 'uai-console-table'
    });
    $(container).empty().append(tableHTML);
  };

  var displaySPCStatusTable = function(profiles, notes, completedReviews, metaReviews, reviewerIds, areachairIds, container, options) {

    var rowData = [];
    var index = 1;
    var sortedAreaChairIds = _.sortBy(_.keys(areachairIds));
    _.forEach(sortedAreaChairIds, function(areaChair) {
      var numbers = areachairIds[areaChair];

      var papers = [];
      _.forEach(numbers, function(number) {
        var note = _.find(notes, ['number', number]);

        if (note) {
          var reviewers = reviewerIds[number];
          var reviews = completedReviews[number];
          var metaReview = _.find(metaReviews, ['invitation', 'auai.org/UAI/2017/-/Paper' + number + '/Meta/Review']);

          papers.push({
            note: note,
            reviewers: reviewers,
            reviews: reviews,
            metaReview: metaReview
          });
        }

      });

      var areaChairProfile = profiles[areaChair];
      rowData.push(buildSPCTableRow(index, areaChairProfile, papers));
      index++;
    });

    var tableHTML = Handlebars.templates['components/table']({
      headings: ['#', 'Area Chair', 'Review Progress', 'Status'],
      rows: rowData,
      extraClasses: 'uai-console-table'
    });
    $(container).empty().append(tableHTML);

  };

  var displayPCStatusTable = function(profiles, notes, completedReviews, metaReviews, reviewerByNote, reviewerById, container, options) {

    var rowData = [];
    var index = 1;
    var sortedReviewerIds = _.sortBy(_.keys(reviewerById));
    _.forEach(sortedReviewerIds, function(reviewer) {
      var numbers = reviewerById[reviewer];

      var papers = [];
      _.forEach(numbers, function(number) {
        var note = _.find(notes, ['number', number]);

        if (note) {
          var reviewerNum = 0;
          var reviewers = reviewerByNote[number];


          for (var revNumber in reviewers) {
            if (reviewer == reviewers[revNumber].id) {
              reviewerNum = revNumber;
              break;
            }
          }

          var reviews = completedReviews[number];
          var review = reviews[reviewerNum];
          var metaReview = _.find(metaReviews, ['invitation', 'auai.org/UAI/2017/-/Paper' + number + '/Meta/Review']);
          if (reviewer == '~Andrey_Kolobov1') {
            console.log('reviewer', reviewer, review);
            console.log('reviews', reviews);
            console.log('reviewers', reviewers);
          }

          papers.push({
            note: note,
            review: review,
            reviewers: reviewers,
            reviews: reviews,
            metaReview: metaReview
          });
        }

      });

      var reviewerProfile = profiles[reviewer];
      rowData.push(buildPCTableRow(index, reviewerProfile, papers));
      index++;
    });

    var tableHTML = Handlebars.templates['components/table']({
      headings: ['#', 'Reviewer', 'Review Progress', 'Status'],
      rows: rowData,
      extraClasses: 'uai-console-table'
    });
    $(container).empty().append(tableHTML);

  };

  var displayError = function(message) {
    message = message || 'The group data could not be loaded.';
    $('#notes').empty().append('<div class="alert alert-danger"><strong>Error:</strong> ' + message + '</div>');
  };


  // Helper functions
  var buildPaperTableRow = function(note, reviewerIds, completedReviews, metaReview, areachairProfile) {
    var number = '<strong class="note-number">' + note.number + '</strong>';

    // Build Note Summary Cell
    note.content.authors = null;  // Don't display 'Blinded Authors'
    var summaryHtml = Handlebars.templates.noteSummary(note);

    // Build Review Progress Cell
    var reviewObj;
    var combinedObj = {};
    var ratings = [];
    for (var reviewerNum in reviewerIds) {
      if (reviewerNum in completedReviews) {
        reviewObj = completedReviews[reviewerNum];
        combinedObj[reviewerNum] = _.assign({}, reviewerIds[reviewerNum], {
          completedReview: true,
          forum: reviewObj.forum,
          note: reviewObj.id,
          rating: reviewObj.rating,
          confidence: reviewObj.confidence,
          reviewLength: reviewObj.content.review.length
        });
        ratings.push(reviewObj.rating);
      } else {
        combinedObj[reviewerNum] = _.assign({}, reviewerIds[reviewerNum], {
          forumUrl: '/forum?' + $.param({
            id: note.forum,
            noteId: note.id,
            invitationId: CONFERENCE + '/-/Paper' + note.number + '/Submit/Review'
          })
        });
      }
    }
    var averageRating = 'N/A';
    var minRating = 'N/A';
    var maxRating = 'N/A';
    if (ratings.length) {
      averageRating = _.round(_.sum(ratings) / ratings.length, 2);
      minRating = _.min(ratings);
      maxRating = _.max(ratings);
    }

    var reviewProgressData = {
      numSubmittedReviews: Object.keys(completedReviews).length,
      numReviewers: Object.keys(reviewerIds).length,
      reviewers: combinedObj,
      averageRating: averageRating,
      maxRating: maxRating,
      minRating: minRating,
      sendReminder: false
    };
    var reviewHtml = Handlebars.templates.noteReviewers(reviewProgressData);

    var areachairProgressData = {
      numMetaReview: metaReview ? 'One' : 'No',
      areachair: areachairProfile,
      metaReview: metaReview
    };
    var areachairHtml = Handlebars.templates.noteAreaChairs(areachairProgressData);

    return [number, summaryHtml, reviewHtml, areachairHtml];
  };

  var buildSPCTableRow = function(index, areaChair, papers) {

    var summary = {
      id: areaChair.id,
      name: areaChair.name,
      email: areaChair.email
    }
    var summaryHtml = Handlebars.templates.committeeSummary(summary);

    var numCompletedReviews = 0;
    var numCompletedMetaReviews = 0;
    var paperProgressData = _.map(papers, function(paper) {
      var ratings = [];
      var numOfReviewers = 0;

      for (var reviewerNum in paper.reviewers) {
        if (reviewerNum in paper.reviews) {
          ratings.push(paper.reviews[reviewerNum].rating);
        }
        numOfReviewers++;
      }

      var averageRating = 'N/A';
      var minRating = 'N/A';
      var maxRating = 'N/A';
      if (ratings.length) {
        averageRating = _.round(_.sum(ratings) / ratings.length, 2);
        minRating = _.min(ratings);
        maxRating = _.max(ratings);
      }

      if (ratings.length == numOfReviewers) {
        numCompletedReviews++;
      }

      if (paper.metaReview) {
        numCompletedMetaReviews++;
      }

      return {
        note: paper.note,
        averageRating: averageRating,
        maxRating: maxRating,
        minRating: minRating,
        numOfReviews: ratings.length,
        numOfReviewers: numOfReviewers,
        metaReview: paper.metaReview
      }
    });

    var reviewProgressData = {
      numCompletedMetaReviews: numCompletedMetaReviews,
      numCompletedReviews: numCompletedReviews,
      numPapers: papers.length,
      papers: _.sortBy(paperProgressData, [function(p) { return p.note.number; }])
    }

    var reviewHtml = Handlebars.templates.notesAreaChairProgress(reviewProgressData);

    var areachairHtml = Handlebars.templates.notesAreaChairStatus(reviewProgressData);

    return [index, summaryHtml, reviewHtml, areachairHtml];
  };


  var buildPCTableRow = function(index, reviewer, papers) {

    var summary = {
      id: reviewer.id,
      name: reviewer.name,
      email: reviewer.email
    }
    var summaryHtml = Handlebars.templates.committeeSummary(summary);

    var reviewProgressData = {
      numCompletedMetaReviews: _.size(_.filter(papers, function(p) { return p.metaReview; })),
      numCompletedReviews: _.size(_.filter(papers, function(p) { return p.review; })),
      numPapers: papers.length,
      papers: _.sortBy(papers, [function(p) { return p.note.number; }])
    }

    var reviewHtml = Handlebars.templates.notesReviewerProgress(reviewProgressData);

    var numCompletedReviews = 0;
    var paperProgressData = _.map(papers, function(paper) {
      var ratings = [];
      var numOfReviewers = 0;

      for (var reviewerNum in paper.reviewers) {
        if (reviewerNum in paper.reviews) {
          ratings.push(paper.reviews[reviewerNum].rating);
        }
        numOfReviewers++;
      }

      var averageRating = 'N/A';
      var minRating = 'N/A';
      var maxRating = 'N/A';
      if (ratings.length) {
        averageRating = _.round(_.sum(ratings) / ratings.length, 2);
        minRating = _.min(ratings);
        maxRating = _.max(ratings);
      }

      if (ratings.length == numOfReviewers) {
        numCompletedReviews++;
      }

      return {
        note: paper.note,
        averageRating: averageRating,
        maxRating: maxRating,
        minRating: minRating,
        numOfReviews: ratings.length,
        numOfReviewers: numOfReviewers,
        metaReview: paper.metaReview
      }
    });

    var reviewStatusData = {
      numCompletedReviews: numCompletedReviews,
      numPapers: papers.length,
      papers: _.sortBy(paperProgressData, [function(p) { return p.note.number; }])
    }

    var areachairHtml = Handlebars.templates.notesReviewerStatus(reviewStatusData);

    return [index, summaryHtml, reviewHtml, areachairHtml];
  };

  var buildNoteMap = function(noteNumbers) {
    var noteMap = Object.create(null);
    for (var i = 0; i < noteNumbers.length; i++) {
      noteMap[noteNumbers[i]] = Object.create(null);
    }
    return noteMap;
  };


  // Kick the whole thing off
  var headerLoaded = $.Deferred();
  displayHeader(headerLoaded);

  $.ajaxSetup({
    contentType: 'application/json; charset=utf-8'
  });

  controller.addHandler('areachairs', {
    token: function(token) {
      var pl = model.tokenPayload(token);
      var user = pl.user;

      getBlindedNotes()
      .then(function(notes) {
        var noteNumbers = _.map(notes, function(note) { return note.number; });
        return $.when(
          notes,
          getOfficialReviews(noteNumbers),
          getMetaReviews(),
          getReviewerGroups(noteNumbers),
          getAreaChairGroups(noteNumbers),
          headerLoaded
        );
      })
      .then(function(blindedNotes, officialReviews, metaReviews, reviewerGroups, areaChairGroups, loaded) {

        var uniqueReviewerIds = _.uniq(_.reduce(reviewerGroups.byNotes, function(result, idsObj, noteNum) {
          return result.concat(_.values(idsObj));
        }, []));

        var uniqueAreaChairIds = _.uniq(_.reduce(areaChairGroups.byNotes, function(result, idsObj, noteNum) {
          return result.concat(_.values(idsObj));
        }, []));

        var uniqueIds = _.union(uniqueReviewerIds, uniqueAreaChairIds);

        return getUserProfiles(uniqueIds)
        .then(function(profiles) {
          console.log('profiles', profiles);
          displayPaperStatusTable(profiles, blindedNotes, officialReviews, metaReviews, reviewerGroups.byNotes, areaChairGroups.byNotes, '#paper-status');
          displaySPCStatusTable(profiles, blindedNotes, officialReviews, metaReviews, reviewerGroups.byNotes, areaChairGroups.byAreaChairs, '#areachair-status');
          displayPCStatusTable(profiles, blindedNotes, officialReviews, metaReviews, reviewerGroups.byNotes, reviewerGroups.byReviewers, '#reviewer-status');
        })
      })
      .fail(function(error) {
        displayError();
      });
    }
  });

  $('#group-container').on('click', 'a.note-contents-toggle', function(e) {
    var hiddenText = 'Show paper details';
    var visibleText = 'Hide paper details';
    var updated = $(this).text() === hiddenText ? visibleText : hiddenText;
    $(this).text(updated);
  });

  $('#group-container').on('click', 'a.send-reminder-link', function(e) {
    var userId = $(this).data('userId');
    var forumUrl = $(this).data('forumUrl');
    var postData = {
      subject: 'UAI 2017 Reminder',
      message: 'This is a reminder to please submit your official reviews for UAI 2017. ' +
        'Click on the link below to go to the review page:\n\n' + window.location.origin + forumUrl + '\n\nThank you.',
      groups: [userId]
    };

    $.post('/mail', JSON.stringify(postData), function(result) {
      promptMessage('A reminder email has been sent to ' + view.prettyId(userId));
    }, 'json').fail(function(error) {
      console.log(error);
      promptError('The reminder email could not be sent at this time');
    });
    return false;
  });

  OpenBanner.breadcrumbs([
    { link: '/', text: 'Venues' },
    { link: '/group?id=' + CONFERENCE, text: view.prettyId(CONFERENCE) }
  ]);
});
</script>
